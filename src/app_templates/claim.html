<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claim Scores</title>
    <style>
        body {
            font-family: Verdana, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
        }
        h1 {
            font-size: 32px;
            text-align: center;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            text-align: center;
            padding: 10px;
            border: 1px solid #ddd;
        }
        th {
            background-color: #4CAF50;
            color: white;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        tr:nth-child(odd) {
            background-color: #ffffff;
        }
        .claim-button {
            margin-top: 20px;
            display: block;
            width: 200px;
            padding: 10px;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 5px;
            text-align: center;
            font-size: 16px;
            text-decoration: none;
            cursor: pointer;
            margin-left: auto;
            margin-right: auto;
        }
        .claim-button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <h1>Claim Scores</h1>
    <form id="claimForm" onsubmit="saveClaimScores(event)">
        <table>
            <thead>
                <tr>
                    <th>Game</th>
                    <th>Score</th>
                    <th>Initials</th>
                </tr>
            </thead>
            <tbody id="scoreTableBody">
                <!-- Rows will be dynamically loaded -->
            </tbody>
        </table>
        <button type="submit" class="claim-button">Submit Claim</button>
    </form>

    <script>
        document.getElementById('claimForm').addEventListener('keydown', function (event) {
                if (event.key === 'Enter') {
                    const activeElement = document.activeElement;
                    if (activeElement.tagName === 'INPUT' && activeElement.type !== 'submit') {
                        event.preventDefault(); // Prevent default Enter key behavior
                    }
                }
            });

        // Function to load scores and initials from the host
        async function loadClaimScores() {
            try {
                const response = await fetch('/load_claim_scores');
                if (!response.ok) {
                    throw new Error('Failed to load claim scores');
                }

                const scores = await response.json();
                const tableBody = document.getElementById('scoreTableBody');
                tableBody.innerHTML = ''; // Clear any existing rows

                scores.forEach((game, gameIndex) => {
                    // Extract the game counter but don't use it
                    const gameCounter = game[0];
                    
                    // Process only the score tuples
                    game.slice(1).forEach(([initials, score], scoreIndex) => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>Game ${gameIndex + 1}</td>
                            <td>${score}</td>
                            <td>
                                <input type="text" 
                                    name="initials_game${gameIndex}_score${scoreIndex}" 
                                    value="${initials}" 
                                    maxlength="3" 
                                    placeholder="ABC" 
                                    style="text-transform:uppercase; text-align:center;" />
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                });
            } catch (error) {
                console.error('Error loading claim scores:', error);
                alert('Unable to load claim scores. Please try again later.');
            }
        }


        // Function to save scores and initials back to the host
        async function saveClaimScores(event) {
            event.preventDefault(); // Prevent form from submitting normally

            const form = document.getElementById('claimForm');
            const formData = new FormData(form);

            // Rebuild the scores array
            const scores = [];
            for (let gameIndex = 0; gameIndex < 4; gameIndex++) {
                const gameCounter = 0; // Default or fetched value
                const game = [gameCounter];
                for (let scoreIndex = 0; scoreIndex < 4; scoreIndex++) {
                    const initials = formData.get(`initials_game${gameIndex}_score${scoreIndex}`) || '';
                    const scoreCell = document.querySelector(
                        `input[name="initials_game${gameIndex}_score${scoreIndex}"]`
                    ).parentElement.previousElementSibling;
                    const score = parseInt(scoreCell.textContent, 10) || 0;
                    game.push([initials, score]);
                }
                scores.push(game);
            }

            try {
                const response = await fetch('/save_claim_scores', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(scores)
                });

                if (!response.ok) {
                    throw new Error('Failed to save claim scores');
                }

                // Redirect to Leader Board page after successful save
                window.location.href = 'leader_board.html';
            } catch (error) {
                console.error('Error saving claim scores:', error);
                alert('Unable to save claim scores. Please try again later.');
            }
        }

        // Load the scores when the page loads
        window.onload = loadClaimScores;
    </script>
</body>
</html>
