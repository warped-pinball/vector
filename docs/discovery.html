
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Discover boards on the network</title>
  <style>
    body { font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif; max-width: 960px; margin: 2.5rem auto; padding: 0 1.5rem 3rem; color: #e5e7eb; background: #0d1117; }
    h1, h2, h3 { color: #e5e7eb; }
    a { color: #38bdf8; text-decoration: none; }
    a:hover { text-decoration: underline; }
    code { background: #0b1221; color: #f8fafc; padding: 2px 6px; border-radius: 6px; border: 1px solid #1d2a3f; }
    pre { background: #0b1221; color: #f8fafc; padding: 1rem; border-radius: 12px; border: 1px solid #1d2a3f; overflow-x: auto; }
    pre code { display: block; font-family: 'Fira Code', 'SFMono-Regular', Consolas, monospace; line-height: 1.5; }
    .panel { background: #111827; border: 1px solid #1f2937; border-radius: 14px; padding: 1.5rem; box-shadow: 0 10px 30px rgba(0,0,0,0.35); margin-bottom: 1.75rem; }
    ol { padding-left: 1.25rem; }
  </style>
</head>
<body>
  <h1>Discover boards on the network</h1>
  <div class="panel">
    <p>The discovery helpers in <code>src/common/discovery.py</code> broadcast a small UDP heartbeat on port <code>37020</code>. Boards elect the lowest IP as the registry device, which replies with the full peer list.</p>
    <p>On a laptop or desktop you will need to implement the wire protocol yourself (you cannot import the MicroPython helpers directly). The script below mirrors the on-device behavior using standard Python sockets.</p>
  </div>
  <div class="panel">
    <h2>Quick start</h2>
    <ol>
      <li>Broadcast a HELLO frame (<code>[1, name_length, name bytes]</code>) on UDP port <code>37020</code>.</li>
      <li>Listen for FULL responses (<code>[2, count, ip bytes..., name length, name bytes]</code>) from the elected registry node.</li>
      <li>Parse the peer map from the FULL payload and refresh it periodically.</li>
    </ol>
    <p>Ready-to-run desktop script:</p>
<pre><code>#!/usr/bin/env python3
import socket
import time

DISCOVERY_PORT = 37020
NAME = "DesktopClient"


def send_hello(sock: socket.socket):
    name_bytes = NAME.encode("utf-8")[:32]
    payload = bytes([1, len(name_bytes)]) + name_bytes
    sock.setsockopt(socket.SOL_SOCKET, socket.SO_BROADCAST, 1)
    sock.sendto(payload, ("255.255.255.255", DISCOVERY_PORT))


def decode_full(data: bytes):
    peers = {}
    if len(data) < 2 or data[0] != 2:
        return peers
    count = data[1]
    offset = 2
    for _ in range(count):
        if len(data) < offset + 5:
            break
        ip_bytes = data[offset : offset + 4]
        offset += 4
        name_len = data[offset]
        offset += 1
        name = data[offset : offset + name_len].decode("utf-8", "ignore")
        offset += name_len
        ip_str = socket.inet_ntoa(ip_bytes)
        peers[ip_str] = name
    return peers


def main():
    sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
    sock.bind(("0.0.0.0", DISCOVERY_PORT))
    send_hello(sock)
    print("Broadcasted discovery HELLO... listening for peers")

    while True:
        sock.settimeout(5)
        try:
            data, addr = sock.recvfrom(1024)
        except socket.timeout:
            send_hello(sock)
            continue

        peers = decode_full(data)
        if peers:
            print(f"Registry {addr[0]} reports peers: {peers}")


if __name__ == "__main__":
    main()
</code></pre>
    <p>Run the script on the same network as the boards. It will rebroadcast a HELLO every few seconds if no responses arrive.</p>
  </div>
  <p><a href="index.html">Back to API reference</a></p>
</body>
</html>
