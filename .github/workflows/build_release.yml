name: Build and Deploy

on:
  pull_request:
  push:
    branches: ["main"]
  release:
    types: [published]

# Default least privilege across the repo unless a job elevates
permissions:
  contents: read
  pull-requests: read

env:
  TARGET_CONFIG: dev/ci/targets.json

jobs:
  pr-ci:
    if: ${{ github.event_name == 'pull_request' }}
    uses: ./.github/workflows/reusable_build_release.yml
    with:
      checkout-ref: ${{ github.event.pull_request.head.sha }}
      include-pr-artifacts: true

  trusted-build-and-release:
    if: ${{ github.event_name != 'pull_request' }}
    uses: ./.github/workflows/reusable_build_release.yml
    with:
      checkout-ref: ${{ github.ref }}
      enable-release-steps: true
    secrets:
      private-key: ${{ secrets.WARPED_PINBALL_PRIVATE_KEY }}
